inputFolders = {...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'IndividualFrames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'IndividualFrames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'IndividualFrames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'IndividualFrames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'IndividualFrames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'IndividualFrames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'IndividualFrames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'IndividualFrames';...
    ...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'OverlayFrames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs' filesep 'OverlayFrames';...
    ...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsFusion' filesep 'FramesCropped';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsFusion' filesep 'FramesCropped';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsFusion' filesep 'FramesCropped';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsFusion' filesep 'FramesCropped';...
    ...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsMVD' filesep 'FramesCropped';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsMVD' filesep 'FramesCropped';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsMVD' filesep 'FramesCropped';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsMVD' filesep 'FramesCropped';...
    ...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending' filesep 'Frames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending' filesep 'Frames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending' filesep 'Frames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending' filesep 'Frames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending' filesep 'Frames';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending' filesep 'Frames';...
    };

inputHeaders = {...
    'DataSet1_TM';...
    'DataSet1_TM';...
    'DataSet2_TM';...
    'DataSet2_TM';...
    'DataSet3_TM';...
    'DataSet3_TM';...
    'DataSet4_TM';...
    'DataSet4_TM';...
    ...
    'TM';...
    'TM';...
    ...
    'Fusion_LargePSF_iter50.fusionSigma_20_8.TM';...
    'Fusion_LargePSF_iter50.fusionSigma_20_8.TM';...
    'Fusion_SmallPSF_iter20.fusionSigma_5_2.TM';...
    'Fusion_SmallPSF_iter20.fusionSigma_5_2.TM';...
    ...
    'MVD_LargePSF_iter50.TM';...
    'MVD_LargePSF_iter50.TM';...
    'MVD_SmallPSF_iter20.TM';...
    'MVD_SmallPSF_iter20.TM';...
    ...
    'SPM00_TM';...
    'SPM00_TM';...
    'SPM00_TM';...
    'SPM01_TM';...
    'SPM01_TM';...
    'SPM01_TM';...
    };

inputFooters = {...
    '.xy.cropped.klb';...
    '.xz.cropped.klb';...
    '.xy.cropped.klb';...
    '.xz.cropped.klb';...
    '.xy.cropped.klb';...
    '.xz.cropped.klb';...
    '.xy.cropped.klb';...
    '.xz.cropped.klb';...
    ...
    '_overlay.xy.cropped.klb';...
    '_overlay.xz.cropped.klb';...
    ...
    '_xy.klb';...
    '_xz.klb';...
    '_xy.klb';...
    '_xz.klb';...
    ...
    '_xy.klb';...
    '_xz.klb';...
    '_xy.klb';...
    '_xz.klb';...
    ...
    '.xy.klb';...
    '.xz.klb';...
    '.yz.klb';...
    '.xy.klb';...
    '.xz.klb';...
    '.yz.klb';...
    };

outputFolders = {...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    ...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ROIs';...
    ...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsFusion';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsFusion';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsFusion';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsFusion';...
    ...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsMVD';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsMVD';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsMVD';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsMVD';...
    ...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending';...
    'V:' filesep 'SV1' filesep 'KM_15-08-10' filesep 'Mmu_E1_mKate2_20150810_160708.corrected.registered' filesep 'ProjectionsBlending';...
    };

outputNames = {...
    'IndividualFrames.DataSet1.xy.klb';...
    'IndividualFrames.DataSet1.xz.klb';...
    'IndividualFrames.DataSet2.xy.klb';...
    'IndividualFrames.DataSet2.xz.klb';...
    'IndividualFrames.DataSet3.xy.klb';...
    'IndividualFrames.DataSet3.xz.klb';...
    'IndividualFrames.DataSet4.xy.klb';...
    'IndividualFrames.DataSet4.xz.klb';...
    ...
    'OverlayFrames.xy.klb';...
    'OverlayFrames.xz.klb';...
    ...
    'Fusion_LargePSF_iter50.xy_cropped.klb';...
    'Fusion_LargePSF_iter50.xz_cropped.klb';...
    'Fusion_SmallPSF_iter20.xy_cropped.klb';...
    'Fusion_SmallPSF_iter20.xz_cropped.klb';...
    ...
    'MVD_LargePSF_iter50.xy_cropped.klb';...
    'MVD_LargePSF_iter50.xz_cropped.klb';...
    'MVD_SmallPSF_iter20.xy_cropped.klb';...
    'MVD_SmallPSF_iter20.xz_cropped.klb';...
    ...
    'SPM00.xy.klb';...
    'SPM00.xz.klb';...
    'SPM00.yz.klb';...
    'SPM01.xy.klb';...
    'SPM01.xz.klb';...
    'SPM01.yz.klb';...
    };

for i = 1:numel(inputFolders)
    disp(' ');
    disp(['* creating ' outputNames{i}]);
    files = dir([inputFolders{i} filesep '' inputHeaders{i} '*' inputFooters{i}]);
    
    maxX = 0;
    maxY = 0;
    sizeTable = zeros(numel(files), 2);
    
    for f = 1:numel(files)
        header = readKLBheader([inputFolders{i} filesep '' files(f).name]);
        sizeTable(f, 1) = header.xyzct(1);
        sizeTable(f, 2) = header.xyzct(2);
        maxX = max(maxX, header.xyzct(1));
        maxY = max(maxY, header.xyzct(2));
    end;
    disp(['  max dimensions: (' num2str(maxX) ', ' num2str(maxY) ')']);
    
    disp('  reading frames');
    stack = zeros(maxX, maxY, numel(files), 'uint16');
    for f = 1:numel(files)
        stack(...
            (round((maxX - sizeTable(f, 1)) / 2) + 1):(round((maxX - sizeTable(f, 1)) / 2) + sizeTable(f, 1)),...
            (round((maxY - sizeTable(f, 2)) / 2) + 1):(round((maxY - sizeTable(f, 2)) / 2) + sizeTable(f, 2)), f) = ...
            readImage([inputFolders{i} filesep '' files(f).name]);
    end;
    
    disp('  saving output stack');    
    writeImage(stack, [outputFolders{i} filesep '' outputNames{i}]);
end;

disp(' ');