%% data sets with automated shift computations

% shiftsName    = 'Shift Data' filesep 'shifts_151026.v2.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_15-10-26' filesep 'Mmu_E1_mKate2_Combined.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_mKate2.TM';
% allTimepoints = 0:649;
% timeSelection = 0:649;
% channels      = 0;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '15-10-26 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections.Combined';

% shiftsName    = 'Shift Data' filesep 'shifts_141009.mat';
% inputString1  = 'X:' filesep 'SV1' filesep 'KM_14-10-09' filesep 'Mmu_E1_H2BmCherryRIKEN_TipTilt_TopScrew_20141009_200202.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_H2BmCherryRIKEN.TM';
% allTimepoints = 0:312;
% timeSelection = 0:312;
% channels      = 0;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '14-10-09 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections.200202';

% shiftsName    = 'Shift Data' filesep 'shifts_150403.mat';
% inputString1  = 'X:' filesep 'SV1' filesep 'KM_15-04-03' filesep 'Mmu_E1_mKate2_0_20150403_151711.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_mKate2.TM';
% allTimepoints = 0:499;
% timeSelection = 0:499;
% channels      = 0;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '15-04-03 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections';

% shiftsName    = 'Shift Data' filesep 'shifts_151026.v1.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_15-10-26' filesep 'Mmu_E1_mKate2_20151026_180901.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_mKate2.TM';
% allTimepoints = 0:270;
% timeSelection = 0:270;
% channels      = 0;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '15-10-26 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections.180901';

% shiftsName    = 'Shift Data' filesep 'shifts_151117.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_15-11-17' filesep 'Mmu_E1_CATGAG1_20151117_175603.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_CATGAG1.TM';
% allTimepoints = 0:307;
% timeSelection = 0:307;
% channels      = 0:1;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '15-11-17 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections';

% shiftsName    = 'Shift Data' filesep 'shifts_160112.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_16-01-12' filesep 'Mmu_H2BmCherry_20160112_135031.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_H2BmCherry.TM';
% allTimepoints = 0:324;
% timeSelection = 0:324;
% channels      = 0;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '16-01-12 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections';

% shiftsName    = 'Shift Data' filesep 'shifts_160315.mat';
% inputString1  = 'X:' filesep 'SV1' filesep 'KM_16-03-15' filesep 'Mmu_E1_CAGTAG1_20160315_164340.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_CAGTAG1.TM';
% allTimepoints = 0:291;
% timeSelection = 0:291;
% channels      = 0:1;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '16-03-15 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections';

% shiftsName    = 'Shift Data' filesep 'shifts_160326.mat';
% inputString1  = 'X:' filesep 'SV1' filesep 'KM_16-03-26' filesep 'Mmu_E1_mKate2_20160326_124921.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_mKate2.TM';
% allTimepoints = 0:368;
% timeSelection = 0:368;
% channels      = 0;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '16-03-26 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections';

%% data sets with manual shift annotations

% shiftsName    = 'Shift Data' filesep 'shifts_160328.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_16-03-28' filesep 'Mmu_E1_H2BmCherry_20160328_170713.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_H2BmCherry.TM';
% allTimepoints = 0:600;
% timeSelection = 0:600;
% channels      = 0;

% shiftsName    = 'Shift Data' filesep 'shifts_160601.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_16-06-01' filesep 'Mmu_E1_CAGTAG1_01_20160601_143144.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_CAGTAG1.TM';
% allTimepoints = 0:500;
% timeSelection = 0:500;
% channels      = 0:1;

% shiftsName    = 'Shift Data' filesep 'shifts_160723.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_16-07-23' filesep 'Mmu_E1_GFPLifeactxmKate2nls_20160723_142607.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_GFPLifeactxmKate2nls.TM';
% allTimepoints = 0:265;
% timeSelection = 0:265;
% channels      = 0:1;

% shiftsName    = 'Shift Data' filesep 'shifts_160726.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_16-07-26' filesep 'Mmu_E1_GaleGFPxmKate2nls_01_20160726_162110.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_GaleGFPxmKate2nls.TM';
% allTimepoints = 0:257;
% timeSelection = 0:257;
% channels      = 0:1;
% copyLocation  = 'E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '16-07-26 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Shifted.Projections';

% shiftsName    = 'Shift Data' filesep 'shifts_160729.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_16-07-29' filesep 'Mmu_E1_H2BeGFP_20160729_145328.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_H2BeGFP.TM';
% allTimepoints = 0:600;
% timeSelection = 0:600;
% channels      = 0;

% shiftsName    = 'Shift Data' filesep 'shifts_160616.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_16-06-16' filesep 'Mmu_E1_TmCherryxH2BeGFP_20160616_155129.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_TmCherryxH2BeGFP.TM';
% allTimepoints = 0:300;
% timeSelection = 0:300;
% channels      = 0:1;

% shiftsName    = 'Shift Data' filesep 'shifts_151205.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_15-12-05' filesep 'Mmu_E1_mKate2' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_mKate2.TM';
% allTimepoints = 0:500;
% timeSelection = 0:500;
% channels      = 0;

% shiftsName    = 'Shift Data' filesep 'shifts_151114.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_15-11-14' filesep 'Mmu_E1_CAGTAG1_01_20151114_123033.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_CAGTAG1.TM';
% allTimepoints = 0:450;
% timeSelection = 0:450;
% channels      = 0;

% shiftsName    = 'Shift Data' filesep 'shifts_140813.mat';
% inputString1  = 'X:' filesep 'SV1' filesep 'KM_14-08-13' filesep 'Mmu_E1_CAGTAG1_TrackingTest_0_20140813_104820.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_CAGTAG1.TM';
% allTimepoints = 0:285;
% timeSelection = 0:285;
% channels      = 0;

% shiftsName    = 'Shift Data' filesep 'shifts_151104.mat';
% inputString1  = 'R:' filesep 'SV1' filesep 'KM_15-11-04' filesep 'Mmu_E1_mKate2_20151104_165657.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_mKate2.TM';
% allTimepoints = 0:350;
% timeSelection = 0:350;
% channels      = 0;

shiftsName    = ['Shift Data' filesep 'shifts_160616.mat'];
inputString1  = ['R:' filesep 'SV1' filesep 'KM_16-06-16' filesep 'Mmu_E1_TmCherryxH2BeGFP_20160616_155129.corrected' filesep 'Results' filesep 'TimeFused.Corrected' filesep 'Mmu_E1_TmCherryxH2BeGFP.TM';]
allTimepoints = 0:300;
timeSelection = 0:300;
channels      = 0:1;
copyLocation  = ['E:' filesep 'Mouse Development' filesep 'Time-Lapse Registration' filesep '16-06-16 Temporal Registration Assessment' filesep 'TimeFused.Corrected.Master.Shifted.Projections'];

%% general parameters

inputString2  = ['_timeFused_blending' filesep 'SPM00_TM'];
inputString3  = '_CM00_CM01_CHN';
inputString4  = '.fusedStack.corrected.klb';              % assumption in code below: stack name ends on 'corrected.klb'
projString1   = '.fusedStack_xyProjection.corrected.klb'; % assumption in code below: projection name ends on 'corrected.klb'
projString2   = '.fusedStack_xzProjection.corrected.klb'; % assumption in code below: projection name ends on 'corrected.klb'
projString3   = '.fusedStack_yzProjection.corrected.klb'; % assumption in code below: projection name ends on 'corrected.klb'

sourceType    = 0; % 0 for manual shift data (pairwise relative vectors), 1 for automated shift data (global vectors)
makeLocalCopy = 1; % put copy of projections in local folder

parallelJobs  = 12;

%% main loop

if makeLocalCopy && exist(copyLocation, 'dir') ~= 7
    mkdir(copyLocation);
end;

load(shiftsName);

if sourceType == 0
    shiftsAll = zeros(numel(allTimepoints), 4);
    shiftsAll(:, 1) = allTimepoints';
    for t = 1:numel(allTimepoints)
        shiftsAll(t, 2) = sum(shifts(shifts(:, 1) <= allTimepoints(t), 2));
        shiftsAll(t, 3) = sum(shifts(shifts(:, 1) <= allTimepoints(t), 3));
        shiftsAll(t, 4) = sum(shifts(shifts(:, 1) <= allTimepoints(t), 4));
    end;
    save(shiftsName, 'shifts', 'shiftsAll');
else
    shiftsAll = zeros(numel(allTimepoints), 4);
    shiftsAll(:, 1) = allTimepoints';
    for t = 1:numel(allTimepoints)
        shiftsAll(t, 2) = round(shifts(shifts(:, 1) == allTimepoints(t), 2));
        shiftsAll(t, 3) = round(shifts(shifts(:, 1) == allTimepoints(t), 3));
        shiftsAll(t, 4) = round(shifts(shifts(:, 1) == allTimepoints(t), 4));
    end;
    save(shiftsName, 'shifts', 'shiftsAll');
end;

minShiftX = min(shiftsAll(:, 2));
maxShiftX = max(shiftsAll(:, 2));
minShiftY = min(shiftsAll(:, 3));
maxShiftY = max(shiftsAll(:, 3));
minShiftZ = min(shiftsAll(:, 4));
maxShiftZ = max(shiftsAll(:, 4));

if matlabpool('size') > 0
    matlabpool('close');
end;
matlabpool(parallelJobs);

parfor t = 1:numel(timeSelection)
    for c = 1:numel(channels)
        disp(['Shifting image stack at TM' num2str(timeSelection(t)) ', channel ' num2str(channels(c))]);
        
        currentShift = shiftsAll(find(shiftsAll(:, 1) == timeSelection(t), 1), 2:4);
        timeString = num2str(timeSelection(t), '%.6d');
        channelString = num2str(channels(c), '%.2d');
        stackName = [inputString1 timeString inputString2 timeString inputString3 channelString inputString4];
        stack = readImage(stackName);
        
        shiftedStack = zeros(...
            size(stack, 1)+maxShiftX-minShiftX, ...
            size(stack, 2)+maxShiftY-minShiftY, ...
            size(stack, 3)+maxShiftZ-minShiftZ, 'uint16');
        
        shiftedStack(...
            (maxShiftX-currentShift(1)+1):(maxShiftX-currentShift(1)+size(stack, 1)), ...
            (maxShiftY-currentShift(2)+1):(maxShiftY-currentShift(2)+size(stack, 2)), ...
            (maxShiftZ-currentShift(3)+1):(maxShiftZ-currentShift(3)+size(stack, 3))) = stack;
        
        shiftedStackXYProj = max(shiftedStack, [], 3);
        shiftedStackXZProj = squeeze(max(shiftedStack, [], 2));
        shiftedStackYZProj = squeeze(max(shiftedStack, [], 1));
        
        shiftedStackName = [stackName(1:(end-3)) 'shifted.klb'];
        shiftedStackXYProjName = [stackName(1:(end-14)) '_xyProjection.corrected.shifted.klb'];
        shiftedStackXZProjName = [stackName(1:(end-14)) '_xzProjection.corrected.shifted.klb'];
        shiftedStackYZProjName = [stackName(1:(end-14)) '_yzProjection.corrected.shifted.klb'];
        writeImage(shiftedStack, shiftedStackName);
        writeImage(shiftedStackXYProj, shiftedStackXYProjName);
        writeImage(shiftedStackXZProj, shiftedStackXZProjName);
        writeImage(shiftedStackYZProj, shiftedStackYZProjName);
        
        if makeLocalCopy
            writeImage(shiftedStackXYProj, [copyLocation inputString2(20:end) timeString inputString3 channelString inputString4(1:(end-14)) '_xyProjection.corrected.shifted.klb']);
            writeImage(shiftedStackXZProj, [copyLocation inputString2(20:end) timeString inputString3 channelString inputString4(1:(end-14)) '_xzProjection.corrected.shifted.klb']);
            writeImage(shiftedStackYZProj, [copyLocation inputString2(20:end) timeString inputString3 channelString inputString4(1:(end-14)) '_yzProjection.corrected.shifted.klb']);
        end;
    end;
end;

if matlabpool('size') > 0
    matlabpool('close');
end;